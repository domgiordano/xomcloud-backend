# Dockerfile for xomcloud-download-tracks Lambda
# Uses AWS Lambda Python base image with ffmpeg

FROM public.ecr.aws/lambda/python:3.11

# Install ffmpeg
RUN yum install -y tar xz && \
    curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -o /tmp/ffmpeg.tar.xz && \
    tar -xf /tmp/ffmpeg.tar.xz -C /tmp && \
    mv /tmp/ffmpeg-*-amd64-static/ffmpeg /usr/local/bin/ && \
    mv /tmp/ffmpeg-*-amd64-static/ffprobe /usr/local/bin/ && \
    rm -rf /tmp/ffmpeg* && \
    yum clean all

# Verify ffmpeg installation
RUN ffmpeg -version

# Copy requirements and install dependencies
COPY requirements.txt ${LAMBDA_TASK_ROOT}/
RUN pip install --no-cache-dir -r ${LAMBDA_TASK_ROOT}/requirements.txt

# Copy Lambda function code
COPY lambdas/ ${LAMBDA_TASK_ROOT}/lambdas/

# Set the handler
CMD ["lambdas.download_tracks.handler.handler"]
